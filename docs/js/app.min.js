"use strict";function Breadcrumbs(t,e,i){this.element=t,this.crumbelements=[],this.highlightedcrumb=-1,this.highlightcolors=[],this.eventListeners={selectNode:[]},this.get_size=e,this.get_color=i}function get_size(t){return t.vereffeningskrediet}function formatAmount(t){return t>=1e3?t.toFixed(0):t>=1?t.toFixed(2):t.toPrecision(3)}function handleCrumbSelection(t){viz.focusNode(t)}function handleNodeSelection(t){bc.showCrumbs(t),bc.highlightCrumb(data[t].depth)}function setupEventHandlers(){document.getElementById("centerfocus").addEventListener("click",function(t){viz.centerFocus()}),document.getElementById("transformationreset").addEventListener("click",function(t){viz.focusNode(0),viz.centerFocus(),viz.requestRender()}),document.getElementById("detail").addEventListener("input",function(t){let e=document.getElementById("detail").value;viz.setLambda(e),viz.requestRender()}),document.getElementById("help").addEventListener("click",function(t){showHelp("Geen hulp beschikbaar. Oh nee!")})}function showHelp(t){function e(){s.style.backgroundColor="transparent",s.style.pointerEvents="none",s.removeChild(a),s.removeEventListener("click",e),document.removeEventListener("click",i),helpshown=!1}function i(t){27===t.keyCode&&e()}if(helpshown)return;helpshown=!0;let s=document.getElementById("helppanel");s.style.backgroundColor="rgba(0,0,0,0.4)",s.style.pointerEvents="auto";let a=document.createElement("div");a.classList.add("messagebox"),a.innerHTML=t,s.appendChild(a),s.addEventListener("click",e),document.addEventListener("keydown",i)}function get_color(t){return colorscheme[t.id.substring(0,2)]}function Rect(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}async function loadShader(t,e,i){let s=fetch("shaders/"+i),a=await s;if(200!==a.status)throw"Failed to fetch shaders "+i;let n=await a.text(),o=t.createShader(e);t.shaderSource(o,n),t.compileShader(o);if(!t.getShaderParameter(o,t.COMPILE_STATUS))throw"Failed to compile shader "+i+". Error: "+t.getShaderInfoLog(o);return o}function createProgram(t,e,i){var s=t.createProgram();t.attachShader(s,e),t.attachShader(s,i),t.linkProgram(s);if(!t.getProgramParameter(s,t.LINK_STATUS))throw"Failed to link program. Error: "+t.getProgramInfoLog(s);return s}function resize(t){var e=window.devicePixelRatio||1,i=t.canvas.clientWidth*e,s=t.canvas.clientHeight*e;return t.canvas.width==i&&t.canvas.height==s||(t.canvas.width=i,t.canvas.height=s,t.viewport(0,0,i,s)),{w:t.canvas.clientWidth,h:t.canvas.clientHeight}}function Visualization(t){this.canvas=t,this.gl=null,this.program=null,this.nleaves=null,this.dims=null,this.transformation={offset:{x:0,y:0},scale:1},this.targettransformation={offset:{x:0,y:0},scale:1},this.lambda=.5,this.heightfactor=.3,this.data=null,this.firstleaf=null,this.renderrequested=!1,this.programlocations={offset:null,scale:null,heightfactor:null,lambda:null},this.colorbuffer=null,this.focusednode=0,this.bumpheights0=[.2,.4,1.5,.064,.0256,.01024],this.bumpheights1=[.01024,.0256,.064,.16,.4,1],this.then=null,this.resized=!1,this.initWebGL(),this.shaderpromise=this.buildShaders(),this.eventListeners={selectNode:[]}}Breadcrumbs.prototype.setData=function(t){this.data=t},Breadcrumbs.prototype.addEventListener=function(t,e){this.eventListeners[t].push(e)},Breadcrumbs.prototype.highlightCrumb=function(t){-1!==this.highlightedcrumb&&(this.crumbelements[this.highlightedcrumb].style.backgroundColor="transparent",this.crumbelements[this.highlightedcrumb].classList.remove("active")),this.highlightedcrumb=t,this.crumbelements[this.highlightedcrumb].style.backgroundColor=this.highlightcolors[t],this.crumbelements[this.highlightedcrumb].classList.add("active")},Breadcrumbs.prototype.showCrumbs=function(t){let e=[t];for(;this.data[t].depth>0;)t=this.data[t].parent,e.unshift(t);let i=[],s=[];for(let t=0;t<e.length;++t){i.push(0===e[t]?"Begroting 2017":this.data[e[t]]["name-nl"]);let a=get_size(data[e[t]])/11322.088;s.push("â‚¬ "+formatAmount(a))}let a=["#bbb"];for(let t=1;t<e.length;++t){let i=this.get_color(this.data[e[t]]),s=Math.round(255*i[0]),n=Math.round(255*i[1]),o=Math.round(255*i[2]);a.push("rgb("+s+", "+n+", "+o+")")}for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.crumbelements=[],this.highlightedcrumb=-1,this.highlightcolors=a;for(let t=0;t<e.length;++t){let a=document.createElement("div");a.classList.add("breadcrumb"),this.element.appendChild(a),this.crumbelements.push(a);let n=document.createElement("button");n.classList.add("item");let o=this;n.addEventListener("click",function(){for(let i=0;i<o.eventListeners.selectNode.length;++i)o.highlightCrumb(t),o.eventListeners.selectNode[i](e[t])});let r=document.createElement("span");r.innerHTML=i[t],r.classList.add("name"),n.appendChild(r);let l=document.createElement("span");l.classList.add("amount"),l.innerHTML=s[t],n.appendChild(l);let h=document.createElement("button");if(h.classList.add("dropdown"),t===e.length-1&&0===this.data[e[t]].children.length)h.innerHTML="&nbsp;",h.classList.add("disabled");else{h.innerHTML='<i class="fa fa-fw fa-chevron-down" aria-hidden="true"></i>';let t=document.createElement("div");t.classList.add("dropdownpanel"),t.innerHTML="hello",a.insertAdjacentElement("afterend",t),t.addEventListener("click",function(e){t.classList.add("collapsed")})}a.appendChild(n),a.appendChild(h)}};let viz=null,bc=null;var data,colorscheme={51:[.28627,.80392,.83922],24:[.94902,.44314,.32157],"01":[.37647,.85098,.51765],33:[.89412,.44706,.83922],52:[.44314,.77647,.27843],16:[.66275,.75294,.2549],17:[.67059,.51765,.93725],18:[.57255,.60784,.89804],12:[.83922,.71373,.21569],14:[.36471,.67451,.8902],13:[.87843,.55686,.19608],44:[.78039,.53333,.79608],"03":[.36078,.68627,.4],19:[.95294,.39608,.58431],32:[.40784,.80392,.65882],46:[.88235,.54118,.69804],25:[.64314,.7451,.45882],23:[.92157,.68235,.93725],"02":[.78431,.69804,.37255],"04":[.89412,.52549,.52549],"05":[.42745,.61569,.87059]},breadcrumbs=[],highlightedcrumb=0,helpshown=!1;document.addEventListener("DOMContentLoaded",async function(){let t=fetch("./data.json");viz=new Visualization(document.getElementById("c")),bc=new Breadcrumbs(document.getElementById("breadcrumbs"),get_size,get_color);let e=await t;if(200!==e.status)throw"Error while fetching data. Server responded with status "+e.status;data=await e.json(),viz.addEventListener("selectNode",handleNodeSelection),viz.visualize(data,get_size,get_color),bc.addEventListener("selectNode",handleCrumbSelection),bc.setData(data),document.getElementById("splash").style.display="none",setupEventHandlers(),viz.requestRender()}),Rect.prototype.contains=function(t){return this.x<=t.x&&t.x<=this.x+this.w&&this.y<=t.y&&t.y<=this.y+this.h},Visualization.prototype.addEventListener=function(t,e){this.eventListeners[t].push(e)},Visualization.bump=function(t,e){return[-4*e/t.w,-4*e/t.h,4*e*(2*t.x+t.w)/t.w,4*e*(2*t.y+t.h)/t.h]},Visualization.prototype.clientToMoney=function(t){return{x:(t.x-this.dims.w/2)/this.transformation.scale-this.transformation.offset.x,y:(this.dims.h/2-t.y)/this.transformation.scale-this.transformation.offset.y}},Visualization.prototype.visualize=async function(t,e,i){this.data=t,this.get_size=e,this.get_color=i,this.buildTreemap(),this.bufferData(),this.dims=resize(this.gl),await this.shaderpromise,this.setupVertexAttributes(),this.setupEventHandlers(),this.then=performance.now(),this.focusNode(0),this.centerFocus()},Visualization.prototype.layout=function(t,e){if(0===t.length)return;if(1===t.length)return void(t[0].rect=e);let i=null;i=e.w>e.h?e.h:e.w;let s=this.get_size(t[0]),a=this.get_size(t[0]),n=this.get_size(t[0]),o=Math.max(i*i*n/(s*s),s*s/(i*i*a)),r=1;for(;r<t.length;){s+=this.get_size(t[r]),a=Math.min(a,this.get_size(t[r])),n=Math.max(n,this.get_size(t[r]));let e=Math.max(i*i*n/(s*s),s*s/(i*i*a));if(e>o){s-=this.get_size(t[r]);break}r+=1,o=e}if(e.w>e.h){let i=s/e.h,a=e.y;for(let s=0;s<r;++s){let n=new Rect(e.x,a,i,this.get_size(t[s])/i);t[s].rect=n,a+=this.get_size(t[s])/i}this.layout(t.slice(r),new Rect(e.x+i,e.y,e.w-i,e.h))}else{let i=s/e.w,a=e.x;for(let s=0;s<r;++s){let n=new Rect(a,e.y,this.get_size(t[s])/i,i);t[s].rect=n,a+=this.get_size(t[s])/i}this.layout(t.slice(r),new Rect(e.x,e.y+i,e.w,e.h-i))}},Visualization.prototype.centerFocus=function(){let t=this.data[this.focusednode],e=.8*Math.min(this.dims.w/(t.rect.w+1),this.dims.h/(t.rect.h+1));this.targettransformation.scale=e,this.targettransformation.offset.x=-(t.rect.x+.5*t.rect.w),this.targettransformation.offset.y=-(t.rect.y+.5*t.rect.h),this.requestRender()},Visualization.prototype.buildShaders=async function(){let t=loadShader(this.gl,this.gl.VERTEX_SHADER,"basic.vert"),e=loadShader(this.gl,this.gl.FRAGMENT_SHADER,"basic.frag"),i=await t,s=await e;this.program=createProgram(this.gl,i,s),this.gl.useProgram(this.program)},Visualization.prototype.initWebGL=function(){if(this.canvas=document.getElementById("c"),this.gl=this.canvas.getContext("webgl"),!this.gl)throw"No WebGL."},Visualization.prototype.relativeToCanvas=function(t,e){let i=this.canvas.getBoundingClientRect();return{x:t-i.x-window.scrollX,y:e-i.y-window.scrollY}},Visualization.prototype.highlightNode=function(t,e){if(0==this.data[t].children.length)this.setLeafColor(t,e?this.get_color(this.data[t]):[1,1,1]);else for(let i=0;i<this.data[t].children.length;++i)this.highlightNode(this.data[t].children[i],e)},Visualization.prototype.focusNode=function(t){this.highlightNode(this.focusednode,!1),this.highlightNode(t,!0),this.focusednode=t,this.uploadColors(),this.requestRender()},Visualization.prototype.setupEventHandlers=function(){function t(t){let e=n.data[0],i=n.clientToMoney(t);if(!e.rect.contains(i)){n.focusNode(0);for(let t=0;t<n.eventListeners.selectNode.length;++t)n.eventListeners.selectNode[t](0);return void n.requestRender()}let s=[0],a=0;for(;;){let t=!1;for(let e=0;e<n.data[a].children.length;++e){let o=n.data[a].children[e];if(n.data[o].rect.contains(i)){s.push(n.data[a].children[e]),a=o,t=!0;break}}if(!t)break}let o=null,r=!1;for(;n.data[a].depth>0;){if(n.data[a].parent===n.focusednode){r=!0;break}a=n.data[a].parent}o=r?a:s[Math.min(Math.max(n.data[n.focusednode].depth,0),s.length-1)],n.focusNode(o);for(let t=0;t<n.eventListeners.selectNode.length;++t)n.eventListeners.selectNode[t](o);n.requestRender()}function e(){let t=[],e=[];o&&(t.push(h),e.push(l));for(let i=0;i<c.length;++i)t.push(u[i]),e.push(f[i]);if(1===t.length)n.transformation.offset.x=(e[0].x-n.dims.w/2)/n.transformation.scale-t[0].x,n.transformation.offset.y=(n.dims.h/2-e[0].y)/n.transformation.scale-t[0].y,n.targettransformation.offset.x=n.transformation.offset.x,n.targettransformation.offset.y=n.transformation.offset.y,n.targettransformation.scale=n.transformation.scale;else if(t.length>=2){let i={x:0,y:0},s={x:0,y:0};for(let a=0;a<t.length;++a)i.x+=t[a].x,i.y+=t[a].y,s.x+=e[a].x,s.y+=e[a].y;i.x/=t.length,i.y/=t.length,s.x/=e.length,s.y/=e.length;let a=0,o=0;for(let n=0;n<t.length;++n){let r=t[n].x-i.x,l=t[n].y-i.y;a+=Math.sqrt(r*r+l*l),r=e[n].x-s.x,l=e[n].y-s.y,o+=Math.sqrt(r*r+l*l)}n.transformation.scale=o/a,n.transformation.offset.x=(s.x-n.dims.w/2)/n.transformation.scale-i.x,n.transformation.offset.y=(n.dims.h/2-s.y)/n.transformation.scale-i.y,n.targettransformation.scale=n.transformation.scale,n.targettransformation.offset.x=n.transformation.offset.x,n.targettransformation.offset.y=n.transformation.offset.y}n.requestRender()}function i(t){c=[],f=[];for(let e=0;e<t.targetTouches.length;++e)c.push(t.targetTouches[e].identifier),f.push(n.relativeToCanvas(t.targetTouches[e].pageX,t.targetTouches[e].pageY))}function s(){o&&(r=l,h=n.clientToMoney(l))}function a(){d=[],u=[];for(let t=0;t<c.length;++t)d.push(f[t]),u.push(n.clientToMoney(f[t]))}let n=this,o=!1,r=null,l=null,h=null,c=[],d=[],f=[],u=[],m=!1;n.canvas.addEventListener("mousedown",function(t){o=!0,l=n.relativeToCanvas(t.pageX,t.pageY),s(),a(),m=0===c.length}),n.canvas.addEventListener("mouseup",function(e){o=!1,a(),m&&t(n.relativeToCanvas(e.pageX,e.pageY))}),n.canvas.addEventListener("touchstart",function(t){t.preventDefault(),i(t),s(),a(),m=!o&&1===c.length}),n.canvas.addEventListener("touchend",function(e){e.preventDefault(),0===e.targetTouches.length&&m&&t(f[0]),i(e),s(),a()}),n.canvas.addEventListener("touchcancel",function(e){e.preventDefault(),0===e.targetTouches.length&&m&&t(f[0]),i(e),s(),a()}),n.canvas.addEventListener("mousemove",function(t){if(l=n.relativeToCanvas(t.pageX,t.pageY),!o)return;e();let i=n.relativeToCanvas(t.pageX,t.pageY),s=i.x-r.x,a=i.y-r.y;s*s+a*a>40&&(m=!1)}),n.canvas.addEventListener("touchmove",function(t){for(let e=0;e<t.changedTouches.length;++e)for(let i=0;i<c.length;++i)if(c[i]==t.changedTouches[e].identifier){let s=n.relativeToCanvas(t.changedTouches[e].pageX,t.changedTouches[e].pageY),a=s.x-d[i].x,o=s.y-d[i].y;a*a+o*o>40&&(m=!1),f[i]=s}e()}),n.canvas.addEventListener("wheel",function(t){if(c.length>0)return;m=!1;let e=null;e=null===l?{x:0,y:0}:n.clientToMoney(l);let i=t.deltaY;1===t.deltaMode?i*=20:2===t.deltaMode&&(i*=n.dims.h),n.transformation.scale=Math.exp(Math.log(n.transformation.scale)-.002*i),n.targettransformation.scale=n.transformation.scale,null!==l&&(n.transformation.offset.x=(l.x-n.dims.w/2)/n.transformation.scale-e.x,n.transformation.offset.y=(n.dims.h/2-l.y)/n.transformation.scale-e.y,n.targettransformation.offset.x=n.transformation.offset.x,n.targettransformation.offset.y=n.transformation.offset.y),a(),n.requestRender()}),window.onresize=function(t){n.resized=!0,n.requestRender()}},Visualization.prototype.setupVertexAttributes=function(){var t=this.gl.getAttribLocation(this.program,"position");this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,40,0),t=this.gl.getAttribLocation(this.program,"polynomial0"),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,4,this.gl.FLOAT,!1,40,8),t=this.gl.getAttribLocation(this.program,"polynomial1"),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,4,this.gl.FLOAT,!1,40,24),t=this.gl.getAttribLocation(this.program,"color"),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,3,this.gl.FLOAT,!1,12,40*this.nleaves*6),this.programlocations.offset=this.gl.getUniformLocation(this.program,"offset"),this.programlocations.scale=this.gl.getUniformLocation(this.program,"scale"),this.programlocations.heightfactor=this.gl.getUniformLocation(this.program,"heightfactor"),this.programlocations.lambda=this.gl.getUniformLocation(this.program,"lambda")},Visualization.prototype.buildTreemap=function(){let t=0,e=this.data[0],i=Math.sqrt(this.get_size(e)*(12/9)),s=this.get_size(e)/i;for(e.rect=new Rect(-i/2,-s/2,i,s),e.polynomial0=Visualization.bump(e.rect,this.bumpheights0[e.depth]),e.polynomial1=Visualization.bump(e.rect,this.bumpheights1[e.depth]),t=0;t<this.data.length;++t){let e=this.data[t];if(0===e.children.length)break;let i=[];for(let t=0;t<e.children.length;++t)i.push(this.data[e.children[t]]);this.layout(i,e.rect);for(let t=0;t<i.length;++t){i[t].polynomial0=e.polynomial0.slice(),i[t].polynomial1=e.polynomial1.slice();let s=Visualization.bump(i[t].rect,this.bumpheights0[i[t].depth]),a=Visualization.bump(i[t].rect,this.bumpheights1[i[t].depth]);i[t].polynomial0[0]+=s[0],i[t].polynomial0[1]+=s[1],i[t].polynomial0[2]+=s[2],i[t].polynomial0[3]+=s[3],i[t].polynomial1[0]+=a[0],i[t].polynomial1[1]+=a[1],i[t].polynomial1[2]+=a[2],i[t].polynomial1[3]+=a[3]}}this.nleaves=data.length-t,this.firstleaf=t},Visualization.prototype.bufferData=function(){let t=[];for(let e=this.firstleaf;e<this.data.length;++e){let i=this.data[e].rect.x,s=this.data[e].rect.y,a=this.data[e].rect.w,n=this.data[e].rect.h,o=this.data[e].polynomial0,r=this.data[e].polynomial1;t.push(i,s,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3],i+a,s,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3],i,s+n,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3],i+a,s,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3],i,s+n,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3],i+a,s+n,o[0],o[1],o[2],o[3],r[0],r[1],r[2],r[3])}this.colorbuffer=[];for(let e=this.firstleaf;e<this.data.length;++e){let i=this.get_color(this.data[e]);t.push(i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2]),this.colorbuffer.push(i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2],i[0],i[1],i[2])}let e=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW)},Visualization.prototype.setLeafColor=function(t,e){let i=t-this.firstleaf;for(let t=0;t<6;++t)this.colorbuffer[18*i+3*t]=e[0],this.colorbuffer[18*i+3*t+1]=e[1],this.colorbuffer[18*i+3*t+2]=e[2]},Visualization.prototype.uploadColors=function(){this.gl.bufferSubData(this.gl.ARRAY_BUFFER,240*this.nleaves,new Float32Array(this.colorbuffer))},Visualization.prototype.animateTransformation=function(t){if(t<=0)return!0;t>100&&(t=100);let e=!0,i=this.targettransformation.offset.x-this.transformation.offset.x,s=this.targettransformation.offset.y-this.transformation.offset.y,a=this.targettransformation.scale-this.transformation.scale,n=Math.sqrt(i*i+s*s+a*a);if(n<=.1*t)this.transformation.offset.x=this.targettransformation.offset.x,this.transformation.offset.y=this.targettransformation.offset.y,this.transformation.scale=this.targettransformation.scale;else if(n<.1/.003){let o=.1*t/n,r=o*this.targettransformation.scale/(o*this.targettransformation.scale+(1-o)*this.transformation.scale);this.transformation.offset.x+=r*i,this.transformation.offset.y+=r*s,this.transformation.scale+=o*a,e=!1}else{let n=.003*t,o=n*this.targettransformation.scale/(n*this.targettransformation.scale+(1-n)*this.transformation.scale);this.transformation.offset.x+=o*i,this.transformation.offset.y+=o*s,this.transformation.scale+=n*a,e=!1}return!e},Visualization.prototype.requestRender=function(){if(this.renderrequested)return;this.then=performance.now();let t=this;requestAnimationFrame(function(e){t.render(e)}),this.renderrequested=!0},Visualization.prototype.render=function(t){let e=t-this.then;this.then=t;let i=this.animateTransformation(e);if(this.resized&&(this.dims=resize(this.gl),this.resized=!1),this.gl.uniform2f(this.programlocations.scale,2*this.transformation.scale/this.dims.w,2*this.transformation.scale/this.dims.h),this.gl.uniform2f(this.programlocations.offset,this.transformation.offset.x,this.transformation.offset.y),this.gl.uniform1f(this.programlocations.heightfactor,this.heightfactor),this.gl.uniform1f(this.programlocations.lambda,Math.pow(this.lambda,2)),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.nleaves>0&&this.gl.drawArrays(this.gl.TRIANGLES,0,6*this.nleaves),i){let t=this;requestAnimationFrame(function(e){t.render(e)})}else this.renderrequested=!1},Visualization.prototype.setLambda=function(t){this.lambda=t};